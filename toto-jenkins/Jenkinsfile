pipeline {
    agent {
        label "$NODE"
    }
    tools {
        nodejs "NODE22"
    }
    options {
        withFolderProperties()
        skipDefaultCheckout(true)
    }
    stages {
        stage("Pre stage")  {
            steps {
                script {
                    if(params.event != "push") {
                        currentBuild.result = "ABORTED"
                        error("Must be a push event, was: " + params.event)
                    }
                    cleanWs()
                    checkout scm
                    echo "${NODE}"
                    echo "${params.event}"
                    echo "${params.delivery}"
                    echo "${params.hook}"
                    echo "${params.trigger}"
                }
            }
        }
        stage("Prepare presentation artifacts") {
            steps {
                script {
                    try {
                        configFileProvider(
                            [configFile(fileId: 'toto-presentation-env', variable: 'ENV_FILE_PATH')]) {
                            sh('bash toto-jenkins/prepare-presentation.sh $ENV_FILE_PATH')                
                        }
                    } catch(Exception ex) {
                        unstable("Error in stage ${env.STAGE_NAME}: " + ex.toString())
                    }
                }
            }
        }
        stage("Deploy presentation") {
            when {
                expression {
                    return currentBuild.currentResult != "UNSTABLE"
                }
            }
            steps {
                script {
                    try {
                        sh('bash toto-jenkins/deploy-presentation.sh $TOTO_PRESENTATION_DEPLOY_DIR $TOTO_PRESENTATION_URL')                
                    } catch(Exception ex) {
                        error("Error in stage ${env.STAGE_NAME}: " + ex.toString())
                    }
                }
            }
        }
    }
    post {
        always {
            script {
                if(params.report) {
                    echo "Sending report..."
                    mail(to: "${MAIL_TO}", subject: "[JENKINS] - ${env.JOB_BASE_NAME} #${env.BUILD_ID} - ${currentBuild.currentResult} ", body: "${env.BUILD_URL}")
                } else {
                    echo "Report disabled, not sending report"
                }
            }
        }
    }
}